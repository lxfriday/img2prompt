{"version":3,"sources":["../src/process.ts","../src/util.ts"],"sourcesContent":["import exiftool from 'dist-exiftool'\r\nimport util from 'util'\r\nimport { execFile } from 'child_process'\r\nimport { IPromptInfo } from './types'\r\nimport { processPrompt } from './util'\r\n\r\nexport async function readImage(imgPath: string): Promise<string> {\r\n  try {\r\n    const { stdout } = await util.promisify(execFile)(exiftool, ['-j', imgPath])\r\n    return JSON.parse(stdout)[0].parameters || ''\r\n  } catch (error) {\r\n    return ''\r\n  }\r\n}\r\n\r\nexport async function readImageV2(imgPath: string): Promise<IPromptInfo> {\r\n  const rawInfo = await readImage(imgPath)\r\n  const promptInfo = processPrompt(rawInfo)\r\n  return promptInfo\r\n}","import { IPromptInfo } from './types'\r\n\r\nexport function safeGet(regex: RegExp, target: string) {\r\n  try {\r\n    return regex.exec(target)![1].trim()\r\n  } catch {\r\n    return ''\r\n  }\r\n}\r\n\r\nexport function safeGetPrompt(target: string) {\r\n  try {\r\n    const idxes = [\r\n      target.indexOf('negative prompt:'),\r\n      target.indexOf('negativeprompt:'),\r\n      target.indexOf('sampler:'),\r\n      target.indexOf('cfg scale:'),\r\n      target.indexOf('seed:'),\r\n      target.indexOf('size:'),\r\n      target.indexOf('model hash:'),\r\n      target.indexOf('model:'),\r\n      target.indexOf('steps:'),\r\n    ].filter((idx) => idx > -1)\r\n    return target.slice(0, Math.min(...idxes, target.length)).trim()\r\n  } catch {\r\n    return ''\r\n  }\r\n}\r\n\r\nexport function safeGetNegativePrompt(target: string) {\r\n  try {\r\n    const negIdxes = [\r\n      target.indexOf('negative prompt:'),\r\n      target.indexOf('negativeprompt:'),\r\n    ].filter((idx) => idx > -1)\r\n    if (negIdxes.length === 0) return ''\r\n    const idx = Math.min(...negIdxes)\r\n    target = target.slice(idx)\r\n    const idxes = [\r\n      target.indexOf('sampler:'),\r\n      target.indexOf('cfg scale:'),\r\n      target.indexOf('seed:'),\r\n      target.indexOf('size:'),\r\n      target.indexOf('model hash:'),\r\n      target.indexOf('model:'),\r\n      target.indexOf('steps:'),\r\n    ].filter((idx) => idx > -1)\r\n    return target\r\n      .slice(0, Math.min(...idxes, target.length))\r\n      .replace('negative prompt:', '')\r\n      .replace('negativeprompt:', '')\r\n      .trim()\r\n  } catch {\r\n    return ''\r\n  }\r\n}\r\n\r\nexport function processPrompt(target: string) {\r\n  target = target.toLowerCase().trim()\r\n  let prompt = safeGetPrompt(target),\r\n    negativePrompt = safeGetNegativePrompt(target),\r\n    sampler = safeGet(/sampler:(.+?),/gi, target),\r\n    cfgScale = safeGet(/cfg scale:(.+?),/gi, target),\r\n    steps = safeGet(/steps:(.+?),/gi, target),\r\n    seed = safeGet(/seed:(.+?),/gi, target),\r\n    size = safeGet(/size:(.+?),/gi, target),\r\n    modelHash = safeGet(/model hash:(.+?),/gi, target),\r\n    model =\r\n      safeGet(/model:(.+?),/gi, target) || safeGet(/model:(.+),?/gi, target)\r\n\r\n  const modelInfo = {\r\n    prompt,\r\n    negativePrompt,\r\n    sampler,\r\n    cfgScale,\r\n    seed,\r\n    size,\r\n    modelHash,\r\n    model,\r\n    steps,\r\n  } as IPromptInfo\r\n  return modelInfo\r\n}\r\n\r\nexport function genEmptyPromptInfo() {\r\n  return {\r\n    prompt: '',\r\n    negativePrompt: '',\r\n    sampler: '',\r\n    cfgScale: '',\r\n    seed: '',\r\n    size: '',\r\n    modelHash: '',\r\n    model: '',\r\n    steps: '',\r\n  } as IPromptInfo\r\n}\r\n"],"mappings":"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","names":["idx"]}